html
    head
        title= title
        link(rel='stylesheet', href='/stylesheets/style.css')
        header("Access-Control-Allow-Origin: *")
        script(src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.2/jquery.min.js")
        script(src="/socket.io/socket.io.js", type='text/javascript')
        script(src="/javascripts/jquery.js", type='text/javascript')
        script(src="/javascripts/jquery.flot.js", type='text/javascript')
        script(src="http://code.highcharts.com/highcharts.js")
        script(src="http://code.highcharts.com/modules/exporting.js")
    body

        h1 BTC Chart

        block content
            div#graph(style="width:100%;height:500px")
            script(type='text/javascript').
                var socket = io('http://localhost:10927', {transports: ['polling']});
                var chart = null;
                var actualDate = new Date();
                function addChartData(chartData, symbol) {
                    if (chart != null && symbol != null) {
                        var index = serieIndex(symbol);
                        var series;
                        if (index >= 0) {
                            series = chart.series[index];
                        } else {
                            series = addNewSerie(chartData.symbol);
                        }
                        // check if new entry is really newer than last entry
                        var isFuture = true;
                        var length = series.data.length;
                        if (length === 1) {
                            if (new Date(series.data[0].x).getTime() == actualDate.getTime()) {
                                series.data[0].remove();
                            }
                            length = series.data.length;
                        }
                        if (length > 0) {
                            isFuture = new Date(chartData.created).getTime() > new Date(series.data[length - 1].x).getTime();
                        }
                        if (isFuture) {
                            var x = new Date(chartData.created).getTime();
                            var y = chartData.price;
                            series.addPoint([x, y], true, false);
                        }
                    }
                };

                chart = new Highcharts.Chart({
                    chart: {
                        renderTo: 'graph',
                        type: 'spline',
                        marginRight: 10,
                        backgroundColor: '#111111',
                        borderColor: '#99AA00',
                        borderWidth: 1,
                        events: addChartData(null)
                    },
                    title: {
                        text: 'BTC/USD price',
                        style: {"color": "#99AA00", "fontSize": "18px"}
                    },
                    xAxis: {
                        type: 'datetime',
                        lineColor: '#99AA00',
                        tickPixelInterval: 100
                    },
                    yAxis: {
                        min: null,
                        max: null,
                        tickInterval: 20,
                        lineColor: '#99AA00',
                        title: {
                            text: 'USD'
                        }
                    },
                    plotOptions: {
                        spline: {
                            lineWidth: 1,
                            marker: {
                                enabled: false
                            },
                            states: {
                                hover: {
                                    lineWidth: 3
                                }
                            }
                        }
                    },
                    tooltip: {
                        enabled: false,
                        formatter: function () {
                            return '<b>' + this.series.name + '</b><br/>' +
                                Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) + '<br/>' +
                                Highcharts.numberFormat(this.y, 2);
                        }
                    },
                    legend: {
                        enabled: true
                    },
                    exporting: {
                        enabled: false
                    },
                    series: [{
                        name: 'Bitcoin',
                        lineColor: '#99AA00',
                        data: (function () {
                            // generate an array of random data
                            var data = [];
                            data.push({
                                x: actualDate,
                                y: null
                            });
                            return data;
                        })()
                    }]
                });

                function serieIndex(seriesName) {
                    for (var i = 0; i < chart.series.length; i++) {
                        if (chart.series[i].name == seriesName) {
                            return i;
                        }
                    }
                    return -1;
                }

                function addNewSerie(newName) {
                    chart.redraw();
                    return chart.addSeries({
                        name: newName,
                        data: (function () {
                            var data = [];
                            data.push({
                                x: actualDate.getTime(),
                                y: null
                            });
                            return data;
                        })(),
                        id: Math.floor(Math.random() * 1000)
                    });
                }

                socket.on('chart', function (data) {
                    if (!$.isArray(data.chartData)) {
                        addChartData(data.chartData, data.symbol);
                    } // TODO handle if it is an array
                });


